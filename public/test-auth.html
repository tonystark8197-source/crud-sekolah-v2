<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auth Test</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .result { margin: 10px 0; padding: 10px; border-radius: 4px; white-space: pre-wrap; font-family: monospace; }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
        .info { background-color: #d1ecf1; color: #0c5460; }
        button { background-color: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; margin: 5px; }
    </style>
</head>
<body>
    <h1>üîê Authentication Test</h1>
    
    <button onclick="checkToken()">1. Check Token</button>
    <button onclick="testLogin()">2. Login</button>
    <button onclick="testGalleryCreate()">3. Test Gallery Create</button>
    <button onclick="clearAuth()">4. Clear Auth</button>
    
    <div id="result" class="result info">Ready to test authentication...</div>

    <script>
        const API_BASE = 'http://localhost:8000/api';
        
        function log(message, type = 'info') {
            const element = document.getElementById('result');
            element.className = `result ${type}`;
            element.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            console.log(message);
        }
        
        function checkToken() {
            const token = localStorage.getItem('adminToken');
            const expiry = localStorage.getItem('adminTokenExpiry');
            
            if (!token) {
                log('‚ùå No token found in localStorage', 'error');
                return;
            }
            
            const isExpired = expiry && Date.now() > parseInt(expiry);
            
            log(`‚úÖ Token found!
Token: ${token.substring(0, 30)}...
Expiry: ${expiry ? new Date(parseInt(expiry)).toLocaleString() : 'Not set'}
Expired: ${isExpired ? 'YES' : 'NO'}`, 'success');
        }
        
        async function testLogin() {
            try {
                log('üîÑ Testing login...', 'info');

                const response = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: 'admin@school.com',
                        password: 'admin123'
                    })
                });

                const data = await response.json();
                console.log('Login response:', data);

                if (response.ok && data.success && data.token) {
                    // Clear any existing auth data first
                    clearAuth();

                    // Store token exactly like Login.jsx does
                    const expiry = Date.now() + (24 * 60 * 60 * 1000); // 24 hours
                    localStorage.setItem('adminToken', data.token);
                    localStorage.setItem('adminUser', JSON.stringify(data.user));
                    localStorage.setItem('adminTokenExpiry', expiry.toString());

                    // Store additional auth data for compatibility
                    const authData = {
                        isAuthenticated: true,
                        username: data.user.name,
                        role: data.user.role,
                        user: data.user,
                        token: data.token,
                        token_type: data.token_type || 'bearer',
                        expires_in: data.expires_in,
                        expires_at: data.expires_at,
                        loginTime: new Date().toISOString()
                    };
                    localStorage.setItem('adminAuth', JSON.stringify(authData));

                    log(`‚úÖ Login successful!
Token: ${data.token.substring(0, 30)}...
User: ${data.user?.name || 'Unknown'}
Role: ${data.user?.role || 'Unknown'}
Expiry: ${new Date(expiry).toLocaleString()}`, 'success');
                } else {
                    log(`‚ùå Login failed: ${data.message || data.error || 'Unknown error'}`, 'error');
                }
            } catch (error) {
                log(`üí• Login error: ${error.message}`, 'error');
            }
        }
        
        async function testGalleryCreate() {
            const token = localStorage.getItem('adminToken');
            if (!token) {
                log('‚ùå No token found. Please login first.', 'error');
                return;
            }
            
            try {
                log('üîÑ Testing gallery create...', 'info');
                
                // Create a simple test FormData
                const formData = new FormData();
                formData.append('title', 'Test Gallery Auth');
                formData.append('description', 'Testing authentication for gallery creation');
                formData.append('category', 'Fasilitas');
                formData.append('featured', 'false');
                formData.append('carousel_pinned', 'false');
                formData.append('is_active', 'true');
                formData.append('sort_order', '0');
                
                // Create a dummy image file
                const canvas = document.createElement('canvas');
                canvas.width = 100;
                canvas.height = 100;
                const ctx = canvas.getContext('2d');
                ctx.fillStyle = '#007bff';
                ctx.fillRect(0, 0, 100, 100);
                ctx.fillStyle = 'white';
                ctx.font = '12px Arial';
                ctx.fillText('TEST', 35, 55);
                
                canvas.toBlob((blob) => {
                    formData.append('image', blob, 'test-image.png');
                    
                    console.log('Form data prepared:');
                    for (let [key, value] of formData.entries()) {
                        console.log(`${key}:`, value);
                    }
                    
                    // Send request
                    fetch(`${API_BASE}/gallery`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        },
                        body: formData
                    })
                    .then(response => {
                        console.log('Response status:', response.status);
                        console.log('Response headers:', [...response.headers.entries()]);
                        
                        return response.text().then(text => {
                            console.log('Raw response:', text);
                            
                            try {
                                const data = JSON.parse(text);
                                
                                if (response.ok) {
                                    log(`‚úÖ Gallery create successful!
ID: ${data.data?.id}
Title: ${data.data?.title}
Image URL: ${data.data?.image_url}`, 'success');
                                } else {
                                    log(`‚ùå Gallery create failed!
Status: ${response.status}
Error: ${data.error || data.message}
Message: ${data.message || 'Unknown error'}`, 'error');
                                }
                            } catch (e) {
                                log(`‚ùå Invalid JSON response!
Status: ${response.status}
Response: ${text}`, 'error');
                            }
                        });
                    })
                    .catch(error => {
                        console.error('Request error:', error);
                        log(`üí• Request error: ${error.message}`, 'error');
                    });
                }, 'image/png');
                
            } catch (error) {
                console.error('Test error:', error);
                log(`üí• Test error: ${error.message}`, 'error');
            }
        }
        
        function clearAuth() {
            localStorage.removeItem('adminToken');
            localStorage.removeItem('adminUser');
            localStorage.removeItem('adminTokenExpiry');
            localStorage.removeItem('adminAuth');
            localStorage.removeItem('jwt_token');
            log('üóëÔ∏è Authentication cleared', 'info');
        }
        
        // Check auth on load
        window.onload = function() {
            checkToken();
        };
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <!-- Dynamic Favicon - will be updated by JavaScript -->
    <link id="favicon" rel="icon" type="image/png" href="/favicon.ico" />
    <link id="apple-touch-icon" rel="apple-touch-icon" href="/favicon.ico" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title id="page-title">Test Fast Loading</title>
    
    <!-- Fast Loading Script (same as main index.html) -->
    <script>
      const startTime = performance.now();
      
      // Fast loading from localStorage for instant title and favicon
      (function() {
        try {
          console.log('üöÄ Fast loading from localStorage...');
          const schoolSettings = localStorage.getItem('schoolSettings');
          
          if (schoolSettings) {
            const settings = JSON.parse(schoolSettings);
            console.log('üì¶ Loaded settings from cache:', settings);

            // Update title with priority: websiteTitle > schoolShortName > default
            const titleElement = document.getElementById('page-title');
            if (settings.websiteTitle) {
              // Priority 1: Use websiteTitle from Settings
              document.title = settings.websiteTitle;
              if (titleElement) titleElement.textContent = settings.websiteTitle;
              console.log('‚úÖ Title loaded from websiteTitle:', settings.websiteTitle);
            } else if (settings.schoolShortName) {
              // Priority 2: Use schoolShortName + suffix
              const formattedTitle = `${settings.schoolShortName} - Sistem Informasi`;
              document.title = formattedTitle;
              if (titleElement) titleElement.textContent = formattedTitle;
              console.log('‚úÖ Title loaded from schoolShortName:', formattedTitle);
            } else {
              console.log('‚ÑπÔ∏è No title data in cache, using default');
            }

            // Update favicon with cache busting
            if (settings.logoUrl && settings.logoUrl !== 'http://localhost:8000/images/logo/logo-school.png') {
              const favicon = document.getElementById('favicon');
              const appleTouchIcon = document.getElementById('apple-touch-icon');

              // Add timestamp to force refresh
              const timestampedUrl = settings.logoUrl.includes('?')
                ? `${settings.logoUrl}&t=${Date.now()}`
                : `${settings.logoUrl}?t=${Date.now()}`;

              if (favicon) favicon.href = timestampedUrl;
              if (appleTouchIcon) appleTouchIcon.href = timestampedUrl;
              console.log('‚úÖ Favicon loaded from cache:', timestampedUrl);
            } else {
              console.log('‚ÑπÔ∏è No logo data in cache, using default favicon');
            }

            // Store load time for performance tracking
            const loadTime = performance.now() - startTime;
            sessionStorage.setItem('fastLoadTime', loadTime.toString());
            console.log('‚ö° Fast load completed in:', loadTime, 'ms');
          } else {
            console.log('‚ÑπÔ∏è No cached settings found, will load from API');
          }
        } catch (e) {
          console.error('‚ùå Failed to load cached school settings:', e);
        }
      })();
    </script>
    
    <style>
        body { font-family: Arial, sans-serif; max-width: 1000px; margin: 0 auto; padding: 20px; }
        .result { margin: 10px 0; padding: 10px; border-radius: 4px; white-space: pre-wrap; font-family: monospace; }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
        .info { background-color: #d1ecf1; color: #0c5460; }
        .warning { background-color: #fff3cd; color: #856404; }
        button { background-color: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; margin: 5px; }
        .performance-info { background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 15px 0; }
        .test-section { border: 1px solid #ddd; padding: 15px; margin: 15px 0; border-radius: 8px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        .metric { display: inline-block; margin: 10px; padding: 10px; background: #e9ecef; border-radius: 4px; }
    </style>
</head>
<body>
    <h1>‚ö° Test Fast Loading dengan localStorage</h1>
    
    <div class="performance-info">
        <h3>üìä Performance Metrics:</h3>
        <div class="metric">
            <strong>Fast Load Time:</strong> <span id="fast-load-time">Calculating...</span>
        </div>
        <div class="metric">
            <strong>Page Load Time:</strong> <span id="page-load-time">Calculating...</span>
        </div>
        <div class="metric">
            <strong>Cache Status:</strong> <span id="cache-status">Checking...</span>
        </div>
        <div class="metric">
            <strong>Title Source:</strong> <span id="title-source">Checking...</span>
        </div>
        <div class="metric">
            <strong>Favicon Source:</strong> <span id="favicon-source">Checking...</span>
        </div>
    </div>

    <div class="performance-info">
        <h3>üéØ Current Status:</h3>
        <p><strong>Page Title:</strong> <span id="current-title">Loading...</span></p>
        <p><strong>Document Title:</strong> <span id="document-title">Loading...</span></p>
        <p><strong>Favicon URL:</strong> <span id="current-favicon">Loading...</span></p>
        <p><strong>Settings Cache:</strong> <span id="settings-cache">Loading...</span></p>
    </div>

    <div class="test-section">
        <h3>üß™ Test Fast Loading</h3>
        <button onclick="testSetSettings()">1. Set Test Settings</button>
        <button onclick="testReload()">2. Reload Page (Test Fast Load)</button>
        <button onclick="testClearCache()">3. Clear Cache</button>
        <button onclick="testPerformance()">4. Performance Test</button>
        
        <div class="form-group">
            <label for="testWebsiteTitle">Test Website Title:</label>
            <input type="text" id="testWebsiteTitle" placeholder="SMA Negeri 1 Jakarta - Unggul dalam Prestasi" value="SMA Negeri 1 Jakarta - Unggul dalam Prestasi">
        </div>
        
        <div class="form-group">
            <label for="testSchoolName">Test School Short Name:</label>
            <input type="text" id="testSchoolName" placeholder="SMAN 1 Jakarta" value="SMAN 1 Jakarta">
        </div>
    </div>

    <div class="test-section">
        <h3>üìà Performance Comparison</h3>
        <button onclick="testWithCache()">Test WITH Cache</button>
        <button onclick="testWithoutCache()">Test WITHOUT Cache</button>
        <button onclick="comparePerformance()">Compare Performance</button>
        
        <div id="performance-results" class="result info">
Performance results will appear here...
        </div>
    </div>
    
    <div id="result" class="result info">Ready to test fast loading...</div>

    <script>
        function log(message, type = 'info') {
            const element = document.getElementById('result');
            element.className = `result ${type}`;
            element.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            console.log(message);
        }
        
        function updateMetrics() {
            // Fast load time
            const fastLoadTime = sessionStorage.getItem('fastLoadTime');
            document.getElementById('fast-load-time').textContent = fastLoadTime ? `${fastLoadTime}ms` : 'N/A';
            
            // Page load time
            const pageLoadTime = performance.now();
            document.getElementById('page-load-time').textContent = `${pageLoadTime.toFixed(2)}ms`;
            
            // Cache status
            const settings = localStorage.getItem('schoolSettings');
            document.getElementById('cache-status').textContent = settings ? 'Available' : 'Empty';
            
            // Title source
            const settingsObj = settings ? JSON.parse(settings) : {};
            let titleSource = 'Default';
            if (settingsObj.websiteTitle) titleSource = 'websiteTitle (Priority 1)';
            else if (settingsObj.schoolShortName) titleSource = 'schoolShortName (Priority 2)';
            document.getElementById('title-source').textContent = titleSource;
            
            // Favicon source
            const faviconSource = settingsObj.logoUrl ? 'logoUrl (Cache)' : 'Default favicon.ico';
            document.getElementById('favicon-source').textContent = faviconSource;
        }
        
        function updateCurrentInfo() {
            // Update current title
            const pageTitle = document.getElementById('page-title');
            document.getElementById('current-title').textContent = pageTitle ? pageTitle.textContent : 'N/A';
            document.getElementById('document-title').textContent = document.title;
            
            // Update current favicon
            const favicon = document.querySelector('link[rel="icon"]') || document.querySelector('link[rel="shortcut icon"]');
            document.getElementById('current-favicon').textContent = favicon ? favicon.href : 'None';
            
            // Update settings cache
            const settings = localStorage.getItem('schoolSettings');
            if (settings) {
                try {
                    const parsed = JSON.parse(settings);
                    document.getElementById('settings-cache').textContent = 
                        `Title: ${parsed.websiteTitle || 'N/A'}, Logo: ${parsed.logoUrl ? 'Set' : 'None'}`;
                } catch (e) {
                    document.getElementById('settings-cache').textContent = 'Invalid JSON';
                }
            } else {
                document.getElementById('settings-cache').textContent = 'No cached settings';
            }
        }
        
        function testSetSettings() {
            try {
                log('üîÑ Setting test settings...', 'info');
                
                const websiteTitle = document.getElementById('testWebsiteTitle').value;
                const schoolShortName = document.getElementById('testSchoolName').value;
                
                const settings = {
                    websiteTitle: websiteTitle,
                    schoolShortName: schoolShortName,
                    logoUrl: 'http://localhost:5174/images/logo/test-logo.png',
                    schoolName: 'Test School Name',
                    schoolAddress: 'Test Address',
                    timestamp: Date.now()
                };
                
                localStorage.setItem('schoolSettings', JSON.stringify(settings));
                
                // Update title immediately
                document.title = websiteTitle;
                const titleElement = document.getElementById('page-title');
                if (titleElement) titleElement.textContent = websiteTitle;
                
                updateMetrics();
                updateCurrentInfo();
                
                log(`‚úÖ Test settings saved!
Website Title: ${websiteTitle}
School Name: ${schoolShortName}
Cache size: ${JSON.stringify(settings).length} bytes`, 'success');
                
            } catch (error) {
                log(`üí• Error setting test settings: ${error.message}`, 'error');
            }
        }
        
        function testReload() {
            log('üîÑ Reloading page to test fast loading...', 'info');
            window.location.reload();
        }
        
        function testClearCache() {
            try {
                log('üßπ Clearing cache...', 'info');
                
                localStorage.removeItem('schoolSettings');
                sessionStorage.removeItem('fastLoadTime');
                
                // Reset title
                document.title = 'Test Fast Loading';
                const titleElement = document.getElementById('page-title');
                if (titleElement) titleElement.textContent = 'Test Fast Loading';
                
                // Reset favicon
                const existingFavicons = document.querySelectorAll('link[rel*="icon"]');
                existingFavicons.forEach(favicon => favicon.remove());
                
                const defaultFavicon = document.createElement('link');
                defaultFavicon.id = 'favicon';
                defaultFavicon.rel = 'icon';
                defaultFavicon.type = 'image/x-icon';
                defaultFavicon.href = '/favicon.ico';
                document.head.appendChild(defaultFavicon);
                
                updateMetrics();
                updateCurrentInfo();
                
                log('‚úÖ Cache cleared and reset to defaults', 'success');
                
            } catch (error) {
                log(`üí• Error clearing cache: ${error.message}`, 'error');
            }
        }
        
        function testPerformance() {
            const startTime = performance.now();
            
            // Simulate loading from localStorage
            const settings = localStorage.getItem('schoolSettings');
            if (settings) {
                const parsed = JSON.parse(settings);
                
                // Simulate title update
                if (parsed.websiteTitle) {
                    document.title = parsed.websiteTitle;
                }
                
                // Simulate favicon update
                if (parsed.logoUrl) {
                    const favicon = document.getElementById('favicon');
                    if (favicon) favicon.href = `${parsed.logoUrl}?t=${Date.now()}`;
                }
            }
            
            const endTime = performance.now();
            const loadTime = endTime - startTime;
            
            log(`‚ö° Performance test completed!
Load time: ${loadTime.toFixed(2)}ms
Cache size: ${settings ? settings.length : 0} bytes
Operations: Title + Favicon update`, 'success');
        }
        
        function testWithCache() {
            const startTime = performance.now();
            
            // Set cache first
            const settings = {
                websiteTitle: 'Cached Title Test',
                logoUrl: 'http://localhost:5174/images/logo/cached-logo.png'
            };
            localStorage.setItem('schoolSettings', JSON.stringify(settings));
            
            // Load from cache
            const cached = localStorage.getItem('schoolSettings');
            const parsed = JSON.parse(cached);
            document.title = parsed.websiteTitle;
            
            const endTime = performance.now();
            
            document.getElementById('performance-results').textContent = 
                `WITH Cache: ${(endTime - startTime).toFixed(2)}ms`;
        }
        
        function testWithoutCache() {
            const startTime = performance.now();
            
            // Clear cache
            localStorage.removeItem('schoolSettings');
            
            // Simulate API call delay
            setTimeout(() => {
                document.title = 'API Loaded Title';
                const endTime = performance.now();
                
                const currentResult = document.getElementById('performance-results').textContent;
                document.getElementById('performance-results').textContent = 
                    `${currentResult}\nWITHOUT Cache: ${(endTime - startTime).toFixed(2)}ms (simulated)`;
            }, 100); // Simulate 100ms API delay
        }
        
        function comparePerformance() {
            log('üîÑ Running performance comparison...', 'info');
            
            testWithCache();
            setTimeout(() => {
                testWithoutCache();
                setTimeout(() => {
                    log('‚úÖ Performance comparison completed! Check results above.', 'success');
                }, 150);
            }, 50);
        }
        
        // Initialize on page load
        window.onload = function() {
            updateMetrics();
            updateCurrentInfo();
            
            // Update metrics every 2 seconds
            setInterval(() => {
                updateMetrics();
                updateCurrentInfo();
            }, 2000);
            
            log('‚úÖ Fast loading test page initialized', 'success');
        };
    </script>
</body>
</html>
